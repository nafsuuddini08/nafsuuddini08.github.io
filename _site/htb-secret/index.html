<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>HTB - Secret - bynafrez08.io</title>
<meta name="description" content="Secret is a linux machine with difficulty esay pulling in the exploitation phase when accessing the machine (which for me has not been easy, I will explaining this in this post) and the escalation of privileges is at medium level of difficulty, and this machine consists secret ways to extract information from applications, and this machine is vulnerable to RCE through an API.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="bynafrez08.io">
<meta property="og:title" content="HTB - Secret">
<meta property="og:url" content="http://localhost:4000/htb-secret/">


  <meta property="og:description" content="Secret is a linux machine with difficulty esay pulling in the exploitation phase when accessing the machine (which for me has not been easy, I will explaining this in this post) and the escalation of privileges is at medium level of difficulty, and this machine consists secret ways to extract information from applications, and this machine is vulnerable to RCE through an API.">



  <meta property="og:image" content="http://localhost:4000/assets/images/img-secret/portada.png">





  <meta property="article:published_time" content="2022-01-05T00:00:00-05:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-secret/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="bynafrez08.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



   <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Article</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/buscador/" >Search</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">HTB - Secret</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar1.png" alt="Nafsu Uddin | AKA bynafrez" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Nafsu Uddin | AKA bynafrez</h3>
    
    
      <p class="author__bio" itemprop="description">
        Networking / Pentesting / Offensive Security
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/bynafrez08" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="HTB - Secret">
    <meta itemprop="description" content="Secret is a linux machine with difficulty esay pulling in the exploitation phase when accessing the machine (which for me has not been easy, I will explaining this in this post) and the escalation of privileges is at medium level of difficulty, and this machine consists secret ways to extract information from applications, and this machine is vulnerable to RCE through an API.">
    <meta itemprop="datePublished" content="January 05, 2022">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">HTB - Secret
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2022-01-05T00:00:00-05:00">January 05, 2022 </time>&emsp;
          
          
        </p>
        <p>Secret is a linux machine with difficulty esay pulling in the exploitation phase when accessing the machine (which for me has not been easy, I will explaining this in this post) and the escalation of privileges is at medium level of difficulty, and this machine consists secret ways to extract information from applications, and this machine is vulnerable to RCE through an API.</p>

<p align="center">
<img src="/assets/images/img-secret/portada.png" />
</p>

<p>Machine rating according to the people.</p>

<p align="center">
<img src="/assets/images/img-secret/calificacion.png" />
</p>

<p>Machine matrix:</p>

<p align="center">
<img src="/assets/images/img-secret/matrix.png" />
</p>

<p>First what we are going to do is create a directory with the name of the machine, and then with the command <strong><em>mkt</em></strong> i am going to create the following directories to organize the files and scripts.</p>

<p align="center">
<img src="/assets/images/img-secret/captura1.png" />
</p>

<p>Mkt is a function that i have defined in my <strong><em>~/.zshrc</em></strong>, which is the following:</p>

<p align="center">
<img src="/assets/images/img-secret/mkt.png" />
</p>

<p>First we send an icmp packet to check if we have connection with the target machine, and trough the TTL we can know what OS have the machine if is linux or windows. Remember that linux machine hava a TTL 64 and windows 128.</p>

<p align="center">
<img src="/assets/images/img-secret/captura2.png" />
</p>

<p>And if we asking why on the output of the ping command have 63 instead of 64? it’s because when we send an icmp packet does not send directly to the target machine, there are some intermediary nodes that pass that packet until arriving the target machine and this make the TTL decrease one unit, so thats why we have 63 instead of 64.</p>

<p align="center">
<img src="/assets/images/img-secret/captura3.png" />
</p>

<p>Anyway, i have a command defined on my shell called <strong><em>wichSystem</em></strong> which is a script in python that specifying the IP address of the target machine and through the TTL it will output if the machine is linux or windows. And also this script makes much less noise and traffic than nmap to know the OS of the target machine.</p>

<p align="center">
<img src="/assets/images/img-secret/ttl.png" />
</p>

<p>wichSystem script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
#coding: utf-8
</span>
<span class="kn">import</span> <span class="nn">re</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">subprocess</span>

<span class="c1"># python3 wichSystem.py YOURIP
</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[!] Uso: python3 "</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">" &lt;direccion-ip&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_ttl</span><span class="p">(</span><span class="n">ip_address</span><span class="p">):</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">"/usr/bin/ping -c 1 </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">ip_address</span><span class="p">,</span> <span class="s">""</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

    <span class="n">ttl_value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r"\d{1,3}"</span><span class="p">,</span> <span class="n">out</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ttl_value</span>

<span class="k">def</span> <span class="nf">get_os</span><span class="p">(</span><span class="n">ttl</span><span class="p">):</span>

    <span class="n">ttl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ttl</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Linux"</span>
    <span class="k">elif</span> <span class="n">ttl</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="ow">and</span> <span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">128</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Windows"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Not Found"</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ttl</span> <span class="o">=</span> <span class="n">get_ttl</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>

    <span class="n">os_name</span> <span class="o">=</span> <span class="n">get_os</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="si">%</span><span class="s">s (ttl -&gt; </span><span class="si">%</span><span class="s">s): </span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">os_name</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="scanning">Scanning</h2>

<p>We are going to perform nmap scanning to discover ports and other relevant information to the target machine, for this we are going to use the following parameters or flags:</p>

<table>
  <thead>
    <tr>
      <th>Flags</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p-</td>
      <td>Means that we want to scan all the ports that exists in tcp and udp which is in total 65,535 ports.</td>
    </tr>
    <tr>
      <td>-sS</td>
      <td>Means that we want tcp syn scan.</td>
    </tr>
    <tr>
      <td>–min-rate 5000</td>
      <td>Means we just want to send packets no slower then 5000 packets per second to discover ports, and with that parameter our scan will be most faster.</td>
    </tr>
    <tr>
      <td>–open</td>
      <td>Means that we want only output the ports with the status open not filtred.</td>
    </tr>
    <tr>
      <td>-vvv</td>
      <td>Means that we want to output more information.</td>
    </tr>
    <tr>
      <td>-n</td>
      <td>Means we don’t want DNS resolution, because sometimes the DNS resolution can take our scan much slower.</td>
    </tr>
    <tr>
      <td>-Pn</td>
      <td>Means that we don’t to ping to discover ports.</td>
    </tr>
    <tr>
      <td>-oN</td>
      <td>Means that we want to save the scan in nmap format to not rescan again, you have more formats to save like nmap, xml, etc.</td>
    </tr>
  </tbody>
</table>

<p>And here we can the result of the scan, and as we can see there is 3 ports on the target machine.</p>

<p align="center">
<img src="/assets/images/img-secret/captura3.png" />
</p>

<h2 id="scanning---port-recognition">Scanning - Port Recognition</h2>

<p>Once we have discovered possible ports, we will perform another scan to recognize the services and versions that use each of these ports. To order to do that we going to use the following parameters or flags:</p>

<table>
  <thead>
    <tr>
      <th>Flags</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-sCV</td>
      <td>Means that we want to use some nmap scripts, in this case to discover the version and services that are running each of those ports.</td>
    </tr>
    <tr>
      <td>-p</td>
      <td>To specify the ports.</td>
    </tr>
    <tr>
      <td>-oN</td>
      <td>Save the scan in nmap format.</td>
    </tr>
  </tbody>
</table>

<p>Remember that nmap have bunch of scripts that we can use, nmap scripts ends in .nse extension (nmap script engine).</p>

<p align="center">
<img src="/assets/images/img-secret/nse.png" />
</p>

<p>Remember that nmap scripts have many categories that we can search for.</p>

<p align="center">
<img src="/assets/images/img-secret/categories.png" />
</p>

<p>Here we can see the result of the scan and we can the versions of the services that are running on those three ports, and it output that the target machine is an ubuntu but it does not specify anu version of ubuntu.</p>

<p align="center">
<img src="/assets/images/img-secret/captura7.png" />
</p>

<p>If we want to know the version of the ubuntu that the target machine is using, what we can do is copy the version of some services like apache or openssh that is using on the target machine and we can search in launchpad to see what version of ubuntu is used that particular version.</p>

<p align="center">
<img src="/assets/images/img-secret/google.png" />
</p>

<p>And we see that it is a ubuntu focal, this will not help us much to exploit the machine, but it would be good for us, to know what machine we are attacking.</p>

<p align="center">
<img src="/assets/images/img-secret/launchpad.png" />
</p>

<p>If we click where is says <strong><em>focal</em></strong>, we can see what version of ubuntu supports focal and we can see which version of ubuntu have focal and in this case we can see that focal is in version 20.4 of ubuntu, and with this we can know that the target machine is usinf ubuntu 20.4 which in this case this version is LTS, this can then be confirmed when we gain access to the machine.</p>

<p align="center">
<img src="/assets/images/img-secret/launchpad2.png" />
</p>

<p>Before we have seen that there is an open port 80, so what can do is with the command <strong><em>whatweb</em></strong> to know if the webserver is using any cms, frameworks that is uses and its version, etc. We are also going to check the port 3000 that uses node.js. And at the moment we don’t anything interesting here, if there is some framework that is vulnerable and that we can exploit.</p>

<p align="center">
<img src="/assets/images/img-secret/whatweb.png" />
</p>

<p>Visiting the websit we can see that the <strong><em>wappalyzer</em></strong> reports us that this website use node.js, wappalyzer is an extesion similar to the command whatweb. And i try to access to the website with the port 3000 and it’s back me on the same website that has on the port 80, so at the moment nothing interesting on the port 3000.</p>

<p align="center">
<img src="/assets/images/img-secret/captura8.png" />
</p>

<p>If we scroll down we can see a button to download to source code fo an API and it will download a zip file. With this we can guess that this website is using an API on the backend side and it’s probably that is on the port 3000, we’ll see later to figure it out.</p>

<p align="center">
<img src="/assets/images/img-secret/captura9.png" />
</p>

<p>If we look the content of the website, we can see that it tells us that there is a field to register through the API and that the data is represented in json format.</p>

<p align="center">
<img src="/assets/images/img-secret/captura11.png" />
</p>

<p>If we try to access on that particular path it will tell us not found, let’s try to check with burpsuite whats is really going on behind.</p>

<p align="center">
<img src="/assets/images/img-secret/captura12.png" />
</p>

<p>In this case i am going togdfghdfgdfgbfvxbfgxt use curl, but you can do the same process with burpsuite. We see that when we send the request with POST it response with “name required”, with this we can know that there is a name field that we need to put to register.</p>

<p align="center">
<img src="/assets/images/img-secret/captura13.png" />
</p>

<p>If we visit the website and will continue scrolling, we see that it tells us that there is a login page on the API for authenticate with a valid user and the way in which the data is represented, which in this case is in json format.</p>

<p align="center">
<img src="/assets/images/img-secret/captura14.png" />
</p>

<p>If we try to access on that particular path it will say again that the following page is not found.</p>

<p align="center">
<img src="/assets/images/img-secret/captura15.png" />
</p>

<p>So let’s do the same process what have we done before, with curl i am going to send the same request with POST. So we can see that is output “email is required”, so with that we know that there is email field to authenticate as an valid user in that particular API.</p>

<p align="center">
<img src="/assets/images/img-secret/captura16.png" />
</p>

<p>Back in on the website, if we continue scrolling it shows us a path that is <strong><em>/api/priv</em></strong> that we dont have a access to.</p>

<p align="center">
<img src="/assets/images/img-secret/captura17.png" />
</p>

<p>And through curl if i try to send a GET request i get back again the “access denied” message, and try to send the same request with POST and nothing happens.</p>

<p align="center">
<img src="/assets/images/img-secret/captura18.png" />
</p>

<p>So what we can do now it’s try to reguster in that API, so with curl we are going to send a POST request method specifying the URL, and with <strong><em>-H</em></strong> flag we are going to specify the data format which in this case is json, because remember that on the website we saw that the representation of the data in regiester form and login form is in json. And with the flag <strong><em>-d</em></strong> we are going to create a user specifying in a json format. And it will output the name of the user in json, so it’s seems that the user is created, let’s going to check.</p>

<p align="center">
<img src="/assets/images/img-secret/captura19.png" />
</p>

<p>So i’am going to send the same request to know if the user is created correctly, and it’s says username and user email already exists, so it will created successfully.</p>

<p align="center">
<img src="/assets/images/img-secret/captura20.png" />
</p>

<p>Before we saw some user credentials on the website in the example json body, so in this we are going to send the same request as will done before and without changing the email and password let’s check is that user exists, and as you can see it outputs that this user is already exits.</p>

<p align="center">
<img src="/assets/images/img-secret/captura21.png" />
</p>

<p>And sending the same request let’s check if there is an admin user, and we can see that there is a admin user.</p>

<p align="center">
<img src="/assets/images/img-secret/captura22.png" />
</p>

<p>So on the website we see that if some user is login successfully on the API it will create a jwt for that user.</p>

<p align="center">
<img src="/assets/images/img-secret/captura_nose.png" />
</p>

<p>Now, let’s try to loggin with the user that we created and if it’s login seccessfully we are going to receive a jwt. and as we can see i login successfully and it will output with the jwt token, and the it will create a new jwt if we login again.</p>

<p align="center">
<img src="/assets/images/img-secret/captura23.png" />
</p>

<p>Now i’am going to try to login with the credentials that was shown on the web page, and it outputs that the password was wrong and we know that the followig email address exists, but we don’t know the password.</p>

<p align="center">
<img src="/assets/images/img-secret/captura24.png" />
</p>

<p>So with gobuester let’s try to fuzzing the web page if we can see another path that is interesting to us, and we don’t see anything interesting except the API path that we already saw.</p>

<p align="center">
<img src="/assets/images/img-secret/captura25.png" />
</p>

<p>Now if we go on the website jwt.io and we paste the jwt that is created us with the user that we have created previously, it will show the data of that jwt on the decoded section. And we can see the username of that jwt which in my case is “test”.</p>

<p align="center">
<img src="/assets/images/img-secret/captura26.png" />
</p>

<p>For example, let’s change the username field in my case i’am going to put the username theadmin and we can see that the jwt it will change.</p>

<p align="center">
<img src="/assets/images/img-secret/captura27.png" />
</p>

<p>We can test with this jwt to see if we can authenticate with the admin user, but it still won’t work since we need the correct signature to authenticate (secret token). we can test the jwt by removing the bit-secret field.</p>

<p align="center">
<img src="/assets/images/img-secret/captura28.png" />
</p>

<p>So if we go back in the documentation on the website, on the private access route that we can’t access as we saw before, we can send a request with the header <strong><em>auth-token</em></strong> that inside we will put the jwt in this case for user admin and if it works successfully it should output us in a json format on the role field that we are admin user, but at the moment will dont’t have the jwt from the admin user.</p>

<p align="center">
<img src="/assets/images/img-secret/priv.png" />
</p>

<p>And in the case that if we use our jwt with the user that we create it will output the following on json:</p>

<p align="center">
<img src="/assets/images/img-secret/normal.png" />
</p>

<p>Now i’am going to send a GET request with the flag “-H” specifying the <strong><em>auth-token</em></strong> header with the token thet we generate in “jwt.io” for testing reasons to see if its’s works, and it’s output “invalid token” and it was obvious that it did not work because we need the secret token for the signature of the jwt of the admin user.</p>

<p align="center">
<img src="/assets/images/img-secret/captura30.png" />
</p>

<p>Let’s try to send the same request with our jwt of the user that we create on the “/api/priv” route. And as you can see it will output in json format that we are normal user, we can pipe it to the command <strong><em>jq</em></strong> to see the data on the json structure (remember that we can do this same process in brupsuite).</p>

<p align="center">
<img src="/assets/images/img-secret/captura31.png" />
</p>

<p>In this case with <strong><em>wfuzz</em></strong> we are going to fuuzzing the <strong><em>/api</em></strong> route specifying the following dictionary to see if there are more routes in that specific route, remember that at the end of the url we need put the word “Fuzz”, and this word it is an integrated word of wfuzz and what allows is to replace that word with the words in the dictionary. And this case it will output responses with 93 characters.</p>

<p align="center">
<img src="/assets/images/img-secret/captura32.png" />
</p>

<p>In this case we are going to specify in wfuzz that we don’t responses with 93 characters and we will going to do that specifying with <strong><em>–hh</em></strong> means “hide characters”. And as we can see that it reports a route called logs that we have not yet accessed.</p>

<p align="center">
<img src="/assets/images/img-secret/captura33.png" />
</p>

<p>If we send the same request as we done before with the “/priv” route indicating the “auth-token” header, we will send the same request but specifying the route that we just discovered now which is <strong><em>/api/logs</em></strong>. And we see that it returns the same output as in the /priv route, i would like to think that we would need the admin user jwt to see the content of the /logs route, so here for now we can do anything.</p>

<p align="center">
<img src="/assets/images/img-secret/captura34.png" />
</p>

<p>So before we download a zip file on the web page let’s unzip it and see what’s it contains, on the web page it tells us that it is the source code of the API.</p>

<p align="center">
<img src="/assets/images/img-secret/captura35.png" />
</p>

<p>We move inside of that directory and we are going to list the files and directories that it contains, and we see that there is a <strong><em>.git</em></strong> folder so we know that this directory is a git project repository.</p>

<p align="center">
<img src="/assets/images/img-secret/captura36.png" />
</p>

<p>So let’s check the file validation.js and here we can see the validation of the reguester and login form, but anything interesting here.</p>

<p align="center">
<img src="/assets/images/img-secret/captura37.png" />
</p>

<p>Let’s check the file <strong><em>index.js</em></strong>, and here we can see that the route <strong><em>/api</em></strong> and <strong><em>/api/user</em></strong> are being imported from the route <strong><em>/routes</em></strong> (specifically <strong><em>/routes/private</em></strong> and <strong><em>/routes/auth</em></strong>), so we take a look of the directory “routes”.</p>

<p align="center">
<img src="/assets/images/img-secret/index.png" />
</p>

<p>So inside of the directory “routes” we can see the following files, let’s check one by one.</p>

<p align="center">
<img src="/assets/images/img-secret/captura38.png" />
</p>

<p>On the file <strong><em>verifytoken.js</em></strong> and it seems that for verify the jwt it will need some secret token from an environment variable. so i guess that we need to find that secret token, so then in jwt.io we paste that secret token in the admin user’s jwt signature part. Now it gets more interesting!!!.</p>

<p align="center">
<img src="/assets/images/img-secret/captura39.png" />
</p>

<p>Let’s check the file <strong><em>auth.js</em></strong>, and we can see the validation for create a user so it will check if the username and email address already exits, and in the case that it exits it will output the message “Email/Name already exist” as we saw before on the curl command and we can the code of creating a user.</p>

<p align="center">
<img src="/assets/images/img-secret/captura40.png" />
</p>

<p>If we continue scrolling down we can the validation for login, so it will check if the email and password is correct and if it’s not it will output the message “Email/Password is wrong” as we saw before when we send a request with the curl command. And if the login is successful it will create a jwt with getting an secret token form env as we saw in the file <strong><em>verifytoken.js</em></strong>. Let’s check if it is an environment variable that is created in hidden files.</p>

<p align="center">
<img src="/assets/images/img-secret/captura41.png" />
</p>

<p>Before we saw a hidden file called <strong><em>.env</em></strong>, and if we check the content of that file we can see that it will connect to some database and the secret token that we can’t see, so nothing here.</p>

<p align="center">
<img src="/assets/images/img-secret/captura42.png" />
</p>

<p>Let’s check the file <strong><em>private.js</em></strong> and here we can see that the user admin is hardcoded, so if we authenticate on the /priv route it will output “welcome back admin” and if we are normal user it will output “your are normal user”(basically it will comparer it we are the admin user or not). So the key here is to convert or authenticate at the user theadmin.</p>

<p align="center">
<img src="/assets/images/img-secret/captura43.png" />
</p>

<p>If we continue scrolling we can see that if we can authenticate with the user “theadmin” we can execute the command <strong><em>git log –online</em></strong> and it will put the content of the variable <strong><em>file (${file})</em></strong>, so if we look at what defined the varible “file” and we can see that it is <strong><em>req.query.file</em></strong>, so this is coming from the client side, basically this is our http request so is getting our query of the parameter name “file” and then passing in over to <strong><em>exec</em></strong> which will execute the command <strong><em>git log –online</em></strong>.</p>

<p>So if we manage to become the user “theadmin” we can control the <strong><em>file</em></strong> parameter or variable that it receives from an GET request, then we could put “git log –online file=whoami” and with this execute commands remotely, and since this does not is sanitized it will may be vulnerable to <strong><em>RCE</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura44.png" />
</p>

<p>Before we jumping in on the exploitation phase we need to find that secret token, so if we check the commits that has been created on this reporsitory we can see one commit which is says <strong><em>“removed .env for security reasons”</em></strong>. So let’s check what changes have done in that commit.</p>

<p align="center">
<img src="/assets/images/img-secret/captura45.png" />
</p>

<p>For check the changes for a particular commit use the command <strong><em>git show</em></strong>, so here we can see the changes which it gives us that secret token.</p>

<p align="center">
<img src="/assets/images/img-secret/captura46.png" />
</p>

<h2 id="exploitation">Exploitation</h2>

<p>Now what we are going to do is go back in jwt.io, put the username “theadmin” as we done before, and we are going to paste that secret token on the signature part and it going to change the jwt.</p>

<p align="center">
<img src="/assets/images/img-secret/captura47.png" />
</p>

<p>So now we are going to do the same request on the /priv route as we done before, and on the header <strong><em>auth-token</em></strong> we are going to paste the token that we generate now in jwt.io. And if it is works it’s gonna say “welcome back admin” message, and we are able to authenticate with the user “theadmin”.</p>

<p align="center">
<img src="/assets/images/img-secret/captura48.png" />
</p>

<p>So let’s try to send the same request but on the /logs route as we enumerate before in wfuzz. Now as we can see it will execute the command <strong><em>git log –oneline</em></strong> but it’s output us <strong><em>undefined</em></strong> because remeber that variable <strong><em>file</em></strong> on the file private.js it’s not receive any data in GET request, and we can try to execute commands since we saw on the code that the <strong><em>git log –online</em></strong> command is executing using the function <strong><em>exec</em></strong>, as i mention previously.</p>

<p align="center">
<img src="/assets/images/img-secret/captura49.png" />
</p>

<p>So to send anu data in GET we need to use the flag <strong><em>-G</em></strong>, and to specify that <strong><em>file</em></strong> variable let’s urlencoded it with the flag <strong><em>–data-urlencode</em></strong> and i’am going to specify the file <strong><em>/etc/passwd</em></strong> (it’s not necessary to put “/etc/passwd” you can put any string to check if it takes our input). And now it output “/etc/passwd” instead of undefined.</p>

<p align="center">
<img src="/assets/images/img-secret/captura50.png" />
</p>

<p>Now let’s going to specify any system command on that variable <strong><em>file</em></strong>, and as we can see we have remote command execution and here we can see the ip address of the target machine which is <strong><em>10.10.11.120</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura51.png" />
</p>

<p>And we can see that the target machine have <strong><em>curl</em></strong>, so now we can establish an reverse shell with curl.</p>

<p align="center">
<img src="/assets/images/img-secret/captura52.png" />
</p>

<p>Now we are going to create a <strong><em>index.html</em></strong> file and we are going to put the following script in bash which is going to establish the reverse shell, and with python we are going to create an http server to host this index.html file.</p>

<p align="center">
<img src="/assets/images/img-secret/captura53.png" />
</p>

<p>Now we are going to listen with <strong><em>netcat</em></strong> in my case on port 4444 and we are going to send the same GET request as we done before, but we are going to specify with curl our attacker ip address and pipe it to <strong><em>bash</em></strong> which is going to interpret our bash script in that index.html file. And as we can see we gain access on the target machine.</p>

<p align="center">
<img src="/assets/images/img-secret/captura54.png" />
</p>

<p>Once we gain access let’s set a proper reverse shell, so in this machine we don’t have a tty so let’s set it with the following commands:</p>

<p align="center">
<img src="/assets/images/img-secret/captura55.png" />
</p>

<p>And we going to export two env variable which is <strong><em>shell=bash</em></strong> and <strong><em>term=xterm</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura56.png" />
</p>

<p>Once we export those two env variable we can use command like <strong><em>clear</em></strong>, we can use <strong><em>ctrl+c</em></strong>, <strong><em>ctrl+l</em></strong>, and move comfortably on the reverse shell terminal as if we were connected to the machine with ssh.</p>

<p align="center">
<img src="/assets/images/img-secret/captura57.png" />
</p>

<p>Now the problem we have is that if use the command <strong><em>nano</em></strong> we see that the proportions is not adequate for our terminal.</p>

<p align="center">
<img src="/assets/images/img-secret/captura58.png" />
</p>

<p>And that happens because if we look the proportions of the reverse shell session, we can see that the number of rows is 24 and the columns is 80.</p>

<p align="center">
<img src="/assets/images/img-secret/captura59.png" />
</p>

<p>And if we go to our terminal we see that the proportions are different.</p>

<p align="center">
<img src="/assets/images/img-secret/captura60.png" />
</p>

<p>And what we can do is on the target machine add the of our terminal proportions using the command <strong><em>stty</em></strong>. And now if we execute nano the size of our terminal is adjusted on the target machine.</p>

<p align="center">
<img src="/assets/images/img-secret/captura61.png" />
</p>

<p>Let’s list user’s that are on the system, and we see can one user with uid 1000 called <strong><em>desith</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura62.png" />
</p>

<p>Let’s move on the home directory of that user, and we can view the first flag which is the <strong><em>user.txt</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura63.png" />
</p>

<h2 id="privesc---enumaration">PrivEsc - Enumaration</h2>

<p>So let’s check how we can convert with root user. So the machine does not have any cron task configured that we can take advantage of, so nothing here.</p>

<p align="center">
<img src="/assets/images/img-secret/captura64.png" />
</p>

<p>And we don’t have permission to access on the root folder, if we look at the version of OS that the machine has we see that is a <strong><em>ubuntu focal version 20.04 LTS</em></strong>, so we were correct in the recognition phase.</p>

<p align="center">
<img src="/assets/images/img-secret/captura65.png" />
</p>

<p>And if we execute the command <strong><em>sudo -l</em></strong> to see the sudo permissions, and it requires the password that we don’t know at the moment. So nothing here.</p>

<p align="center">
<img src="/assets/images/img-secret/captura66.png" />
</p>

<p>With the <strong><em>find</em></strong> command let’s check what interesting files on the system have SUID permission, which is the permission <strong><em>4000</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura67.png" />
</p>

<p>If we pipe it the previus command with <strong><em>grep</em></strong> using the flag <strong><em>-vE</em></strong> for Invert the sense of matching to ignore the path snap and lib, we can a file called <strong><em>count</em></strong> on the <strong><em>/opt</em></strong> with SUID permission and it’s created by the root user. Let’s going to check this file.</p>

<p align="center">
<img src="/assets/images/img-secret/captura68.png" />
</p>

<p>So basically the file <strong><em>count</em></strong> is a executable which selecting any file that have on the system it will tell us the line, words and characters that have that file. Basically this little script is like when we use the command <strong><em>wc</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura69.png" />
</p>

<p>So on that executable it ask us for saveing the file, if we save the file and view the content of that file it’s just store the results of that script, but not the content of the file that we specify. So we know that this script it will read any file of the system but it will not show the content, hmm interesing…</p>

<p align="center">
<img src="/assets/images/img-secret/captura70.png" />
</p>

<p>So if we execute the file and we specify the flag root.txt it will read that file, but not show the content of that file. So here we know that this script can read any files on the system included of the root user.</p>

<p align="center">
<img src="/assets/images/img-secret/captura71.png" />
</p>

<p>So we are able to read the code of that script, and if we look the main function of the code it’s says <strong><em>“enable coredump”</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura72.png" />
</p>

<p>So coredump is a <strong><em>file that generated automatically by the kernel after any program or computer crashed</em></strong>, and that file contains the status of the memory, the processor register’s contents, memory managment information, the programs counter and stack pointer, etc. Basically when an execption occurs while the program is running the data is stored in memory (basically when the program crashes).</p>

<p>What we know now is that the binary <strong><em>count</em></strong> have SUID permission and the owner is root, and that is why it allows us to read all the system files. So what we have to do now is run the binary and cause a coredump and try to generate an execption and with that for store that report of the coredump in any system path, in this on the <strong><em>/var/crash</em></strong> path (a report when the program crashed).</p>

<p align="center">
<img src="/assets/images/img-secret/captura73.png" />
</p>

<p>So in this case what i’am going to do is execute the binary <strong><em>count</em></strong> and i want to specify that i want to read the file “root.txt”, and once it reads the file content, the program will ask us if we want to save the results in a file and this is where we are going to generate this coredump since the program is not finish yet, what we are going to do is while the program is running is put it in the background process with <strong><em>ctrl+z</em></strong>. And if we execute the command <strong><em>ps</em></strong> we can see the <strong><em>count</em></strong> binary in a background process with his <strong><em>PID</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura74.png" />
</p>

<p>So a coredump occurs when data is corrupted, when a file is infected by malware, and in this case when a segmentation fault or a <strong><em>bus error</em></strong>. So what we can do is kill the bus of this process by specifying the PID, and if we now execute the <strong><em>fg</em></strong> command to return the process that we have left in the background, it tell us a <strong><em>bus error</em></strong> and that it has caused a <strong><em>core dump</em></strong>. We see that the process continues executing, but here an exception has been generated since we have killed parts of that process (so thats why it’s says coredump).</p>

<p align="center">
<img src="/assets/images/img-secret/captura75.png" />
</p>

<p>And if we list the directory <strong><em>/var/crash</em></strong> we can see that is generate a new report specifying the user UID, which our case is 1000 because since with the user that we are logged in now have the UID 1000.</p>

<p align="center">
<img src="/assets/images/img-secret/captura76.png" />
</p>

<p>So what we can do now is with a system tool called <strong><em>apport-unpack</em></strong> let’s say to unzip that file in to a path that we are going to specify, in my case it will be <strong><em>/tmp/test1</em></strong>. And we see that there is a file called <strong><em>coredump</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura77.png" />
</p>

<p>Now if we try to view the contents of this file with the <strong><em>cat</em></strong> command, we will view the content of that file very messy.</p>

<p align="center">
<img src="/assets/images/img-secret/captura78.png" />
</p>

<p>What we can do in this situation is use the command <strong><em>strings</em></strong> and specify that file. Inside the file there will be information about the system and the memory as I mentioned before, but if continue to scrolling ip we can view the content of the file that we have specified in the binary <strong><em>count</em></strong>, which in this case is the <strong><em>root.txt</em></strong> flag.</p>

<p align="center">
<img src="/assets/images/img-secret/captura79.png" />
</p>

<h2 id="privesc">PrivEsc</h2>

<p>And now to gain access as the root user, we are going to try to get the <strong><em>id_rsa</em></strong> of the root user to access with ssh, remember that we can read all the system files with this binary. So we are going to do the same process as we done before.</p>

<p align="center">
<img src="/assets/images/img-secret/captura80.png" />
</p>

<p>Now we unpack that report that has been generated in <strong><em>/var/crash</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura81.png" />
</p>

<p>And if we now see the content of the file <strong><em>coredump</em></strong> with the <strong><em>strings</em></strong> command we can see the <strong><em>private ssh key</em></strong> of the root user.</p>

<p align="center">
<img src="/assets/images/img-secret/captura82.png" />
</p>

<p>And now what we are going to do is create a file on our attacker machine and save paste that id_rsa and give the owner read and write permissions <strong><em>(permission 600)</em></strong>.</p>

<p align="center">
<img src="/assets/images/img-secret/captura83.png" />
</p>

<p>And now with ssh with the flag <strong><em>-i</em></strong> we are going to specify that private key and we will have access to the target machine as the root user. With this we have already pwned!!! the whole machine.</p>

<p align="center">
<img src="/assets/images/img-secret/captura84.png" />
</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#hack-the-box" class="page__taxonomy-item" rel="tag">Hack the box</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#linux" class="page__taxonomy-item" rel="tag">Linux</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#ctf" class="page__taxonomy-item" rel="tag">CTF</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#pentest" class="page__taxonomy-item" rel="tag">Pentest</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Fecha:</strong> <time datetime="2022-01-05T00:00:00-05:00">January 05, 2022</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-previse/" class="pagination--pager" title="HTB - Previse
">Previous</a>
    
    
      <a href="/htb-horizontall/" class="pagination--pager" title="HTB - Horinzontall
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 bynafrez08.io</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
